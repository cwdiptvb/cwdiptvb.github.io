<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script>
    async function servePlaylist() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) {
        document.body.textContent = 'Error: Missing ?id parameter';
        return;
      }

      try {
        const response = await fetch('/admin/channel.json');
        if (!response.ok) throw new Error('Failed to load channel.json');
        const channels = await response.json();

        // Support both array of channels or single object
        const channel = Array.isArray(channels)
          ? channels.find(c => c.id === id || c.name === id)
          : (channels.id === id || channels.name === id ? channels : null);

        if (!channel) {
          document.body.textContent = 'Error: Channel not found';
          return;
        }

        let playlist = '#EXTM3U\n';

        let attributes = [];
        if (channel.name) attributes.push(`NAME="${channel.name}"`);
        if (channel.codecs) attributes.push(`CODECS="${channel.codecs}"`);
        if (channel.resolution) attributes.push(`RESOLUTION=${channel.resolution}x0`);

        if (attributes.length > 0) {
          playlist += `#EXT-X-STREAM-INF:${attributes.join(',')}\n`;
        }

        let streamURL = channel.url;
        if (channel.proxy) {
          streamURL = `https://hlsr.vercel.app/api/proxy?url=${encodeURIComponent(channel.url)}`;
        }
        playlist += `${streamURL}\n`;

        // Replace document with raw playlist text
        document.open();
        document.write(playlist);
        document.close();

      } catch (err) {
        document.body.textContent = 'Error: ' + err.message;
      }
    }

    servePlaylist();
  </script>
</head>
<body>
</body>
</html>
