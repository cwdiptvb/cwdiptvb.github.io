<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script>
    async function servePlaylist() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) {
        document.body.textContent = 'Error: Missing ?id parameter';
        return;
      }

      try {
        const response = await fetch('/admin/channel.json');
        if (!response.ok) throw new Error('Failed to load channel.json');
        const channels = await response.json();

        const channel = Array.isArray(channels)
          ? channels.find(c => c.id === id || c.name === id)
          : (channels.id === id || channels.name === id ? channels : null);

        if (!channel) {
          document.body.textContent = 'Error: Channel not found';
          return;
        }

        let playlist = '#EXTM3U\n';
        let attrs = [];
        if (channel.name) attrs.push(`NAME="${channel.name}"`);
        if (channel.codecs) attrs.push(`CODECS="${channel.codecs}"`);
        if (channel.resolution) attrs.push(`RESOLUTION=${channel.resolution}x0`);
        if (attrs.length) playlist += `#EXT-X-STREAM-INF:${attrs.join(',')}\n`;

        let streamURL = channel.proxy
          ? `https://hlsr.vercel.app/api/proxy?url=${encodeURIComponent(channel.url)}`
          : channel.url;
        playlist += streamURL + '\n';

        const blob = new Blob([playlist], { type: 'application/vnd.apple.mpegurl' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${id}.m3u8`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);

        document.body.textContent = `Playlist for ${id} downloaded.`;

      } catch (err) {
        document.body.textContent = 'Error: ' + err.message;
      }
    }

    servePlaylist();
  </script>
</head>
<body>
</body>
</html>
