<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Channel catalog editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1216; --panel:#171b22; --card:#1c2129; --text:#e6e6e6;
      --muted:#a9b0bd; --accent:#4f9cf4; --accent-2:#22c55e; --danger:#ef4444;
      --warning:#f59e0b; --border:#2a313b; }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;}
    header{background:var(--panel);border-bottom:1px solid var(--border);padding:12px 16px;
      display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;}
    header .title{font-size:18px;font-weight:600;}
    header .actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn{padding:8px 12px;border:1px solid var(--border);background:var(--card);
      color:var(--text);border-radius:8px;cursor:pointer;font-weight:600;}
    .btn.accent{background:var(--accent);color:#0b1a2b;border-color:transparent;}
    .btn.success{background:var(--accent-2);color:#0b1a2b;border-color:transparent;}
    .btn.warn{background:var(--warning);color:#1a1202;border-color:transparent;}
    .btn.danger{background:var(--danger);color:#2b0b0b;border-color:transparent;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    main{padding:16px;}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:12px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;}
    .card.selected{outline:2px solid var(--accent);}
    .card.proxy-on{border-color:var(--accent-2);}
    .top{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;margin-bottom:8px;}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;background:var(--panel);border:1px solid var(--border);color:var(--muted);}
    .grid{display:grid;gap:8px;}
    .row{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;}
    .row input{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--text);}
    .checkbox{display:inline-flex;align-items:center;gap:6px;color:var(--muted);}
    .footer-actions{display:flex;gap:8px;margin-top:12px;}
    .log-overlay,.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:100;}
    .log,.modal{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;width:min(520px,92vw);max-height:80vh;overflow:auto;}
    .log pre{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--muted);white-space:pre-wrap;}
  </style>
</head>
<body>
  <header>
    <div class="title">Channel catalog editor</div>
    <div class="actions">
      <button class="btn accent" id="loadBtn">Reload</button>
      <button class="btn success" id="saveBtn" disabled>Save to GitHub</button>
      <button class="btn warn" id="importBtn">Import M3U</button>
      <button class="btn" id="batchBtn" disabled>Batch edit</button>
      <button class="btn" id="addBtn">Add channel</button>
      <button class="btn danger" id="deleteBtn" disabled>Delete Selected</button>
      <button class="btn" id="selectAllBtn">Select: ☐</button>
    </div>
  </header>
  <main>
    <section class="cards" id="cards"></section>
  </main>

  <!-- Deployment log -->
  <div class="log-overlay" id="logOverlay">
    <div class="log">
      <h3>Deployment log</h3>
      <pre id="logPre"></pre>
      <button class="btn" id="closeLog">Close</button>
    </div>
  </div>

  <!-- API key prompt -->
  <div class="modal-overlay" id="tokenModalOverlay">
    <div class="modal">
      <h3>GitHub API key</h3>
      <div class="row">
        <label>API key</label>
        <input type="password" id="tokenModalInput" placeholder="ghp_..." />
        <button class="btn success" id="tokenModalSet">Continue</button>
      </div>
    </div>
  </div>

  <!-- Import M3U modal -->
  <div class="modal-overlay" id="importModalOverlay">
    <div class="modal">
      <h3>Import M3U</h3>
      <div class="row">
        <label>From URL</label>
        <input type="url" id="m3uUrl" placeholder="https://example.com/playlist.m3u8" />
        <button class="btn" id="fetchM3uUrlBtn">Import</button>
      </div>
      <div class="row">
        <label>From File</label>
        <input type="file" id="m3uFile" accept=".m3u,.m3u8,text/plain" />
        <button class="btn" id="importM3uFileBtn">Import</button>
      </div>
      <button class="btn" id="closeImportModal">Close</button>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <div class="modal-overlay" id="deleteModalOverlay">
    <div class="modal">
      <h3>Confirm deletion</h3>
      <p id="deleteMessage"></p>
      <div class="footer-actions">
        <button class="btn" id="cancelDelete">Cancel</button>
        <button class="btn danger" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>

  <script>
    const fixedConfig={owner:'cwdiptvb',repo:'cwdiptvb.github.io',path:'admin/channel.json',branch:'main',catalogUrl:'https://cwdiptvb.github.io/admin/channel.json'};
    const state={channels:[],selected:new Set(),token:null};
    const el={
      cards:document.getElementById('cards'),
      loadBtn:document.getElementById('loadBtn'),
      saveBtn:document.getElementById('saveBtn'),
      batchBtn:document.getElementById('batchBtn'),
      addBtn:document.getElementById('addBtn'),
      deleteBtn:document.getElementById('deleteBtn'),
      selectAllBtn:document.getElementById('selectAllBtn'),
      tokenModalOverlay:document.getElementById('tokenModalOverlay'),
      tokenModalInput:document.getElementById('tokenModalInput'),
      tokenModalSet:document.getElementById('tokenModalSet'),
      importBtn:document.getElementById('importBtn'),
      importModalOverlay:document.getElementById('importModalOverlay'),
      closeImportModal:document.getElementById('closeImportModal'),
      fetchM3uUrlBtn:document.getElementById('fetchM3uUrlBtn'),
      m3uUrl:document.getElementById('m3uUrl'),
      m3uFile:document.getElementById('m3uFile'),
      importM3uFileBtn:document.getElementById('importM3uFileBtn'),
      deleteModalOverlay:document.getElementById('deleteModalOverlay'),
      deleteMessage:document.getElementById('deleteMessage'),
      cancelDelete:document.getElementById('cancelDelete'),
      confirmDelete:document.getElementById('confirmDelete'),
      logOverlay:document.getElementById('logOverlay'),
      logPre:document.getElementById('logPre'),
      closeLog:document.getElementById('closeLog')
    };

    function saveCache(){localStorage.setItem('channelEditorCache',JSON.stringify(state.channels));}
    function loadCache(){const c=localStorage.getItem('channelEditorCache');if(c){try{state.channels=JSON.parse(c);return true;}catch{}}return false;}
    function clearCache(){localStorage.removeItem('channelEditorCache');}

    function updateSelectAllButton(){
      const total=state.channels.length,sel=state.selected.size;
      if(sel===0) el.selectAllBtn.textContent='Select: ☐';
      else if(sel===total) el.selectAllBtn.textContent='Select: ☑';
      else el.selectAllBtn.textContent='Select: ▭';
    }

    function renderCards(){
      el.cards.innerHTML='';
      state.channels.forEach((c,i)=>{
        const card=document.createElement('div');
        card.className='card'+(state.selected.has(i)?' selected':'')+(c.proxy?' proxy-on':'');
        card.dataset.index=i;
        const top=document.createElement('div');top.className='top';
        const select=document.createElement('input');select.type='checkbox';select.checked=state.selected.has(i);
        select.addEventListener('change',()=>{if(select.checked)state.selected.add(i);else state.selected.delete(i);renderCards();});
        const title=document.createElement('div');title.innerHTML=`<strong>${c.name||'(untitled)'}</strong><span class="tag">id:${c.id||''}</span>`;
        const badge=document.createElement('span');badge.className='badge';badge.textContent=c.proxy?'Proxy:ON':'Proxy:OFF';
        top.appendChild(select);top.appendChild(title);top.appendChild(badge);card.appendChild(top);
        // Simplified: show URL only
        const row=document.createElement('div');row.className='row';
        const input=document.createElement('input');input.type='url';input.value=c.url||'';
        const apply=document.createElement('button');apply.className='btn';apply.textContent='Apply';
        apply.addEventListener('click',()=>{c.url=input.value;saveCache();renderCards();});
        row.appendChild(document.createTextNode('URL'));row.appendChild(input);row.appendChild(apply);
        card.appendChild(row);
        el.cards.appendChild(card);
      });
      el.deleteBtn.disabled=state.selected.size===0;
      updateSelectAllButton();
    }

    // Select all toggle
    el.selectAllBtn.addEventListener('click',()=>{
      const total=state.channels.length,sel=state.selected.size;
      if(sel<total) state.selected=new Set(state.channels.map((_,i)=>i));
      else state.selected.clear();
      renderCards();
    });

    // Import M3U modal
    el.importBtn.addEventListener('click',()=>{el.importModalOverlay.style.display='flex';});
    el.closeImportModal.addEventListener('click',()=>{el.importModalOverlay.style.display='none';});
    el.fetchM3uUrlBtn.addEventListener('click',async()=>{
      const url=el.m3uUrl.value.trim();if(!url)return;
      const res=await fetch(url);const text=await res.text();
      const lines=text.split(/\r?\n/).filter(l=>l&&!l.startsWith('#'));
      lines.forEach((line,i)=>{state.channels.push({name:'Imported '+(i+1),id:'import-'+i,url:line,proxy:line.startsWith('http://'),_enabled:{url:true}});});
      saveCache();renderCards();el.importModalOverlay.style.display='none';
    });
    el.importM3uFileBtn.addEventListener('click',async()=>{
      const file=el.m3uFile.files[0];if(!file)return;
      const text=await file.text();
      const lines=text.split(/\r?\n/).filter(l=>l&&!l.startsWith('#'));
      lines.forEach((line,i)=>{state.channels.push({name:'Imported '+(i+1),id:'import-'+i,url:line,proxy:line.startsWith('http://'),_enabled:{url:true}});});
      saveCache();renderCards();el.importModalOverlay.style.display='none';
    });

    // Delete confirmation
    el.deleteBtn.addEventListener('click',()=>{
      const names=Array.from(state.selected).map(i=>state.channels[i].name||state.channels[i].id);
      el.deleteMessage.textContent='Are you sure you want to delete? Selected Channels: '+names.join(', ');
      el.deleteModalOverlay.style.display='flex';
    });
    el.cancelDelete.addEventListener('click',()=>{el.deleteModalOverlay.style.display='none';});
    el.confirmDelete.addEventListener('click',()=>{
      state.channels=state.channels.filter((_,i)=>!state.selected.has(i));
      state.selected.clear();saveCache();renderCards();
      el.deleteModalOverlay.style.display='none';
    });

    // GitHub save (simplified)
    el.saveBtn.addEventListener('click',async()=>{
      if(!state.token)return alert('API key required');
      showLog();logStep('Saving to GitHub...');
      try{
        const content=new TextEncoder().encode(JSON.stringify(state.channels,null,2));
        const base64=btoa(String.fromCharCode(...content));
        const url=`https://api.github.com/repos/${fixedConfig.owner}/${fixedConfig.repo}/contents/${fixedConfig.path}`;
        const body={message:'Update catalog',content:base64,branch:fixedConfig.branch};
        const res=await fetch(url,{method:'PUT',headers:{Authorization:`Bearer ${state.token}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!res.ok)throw new Error('Commit failed');
        logStep('Commit successful');clearCache();
      }catch(err){logStep('ERROR:'+err.message);}
    });

    // Log overlay
    function logStep(msg){el.logPre.textContent+=msg+"\\n";}
    function showLog(){el.logOverlay.style.display='flex';el.logPre.textContent='';}
    el.closeLog.addEventListener('click',()=>{el.logOverlay.style.display='none';});

    // Token prompt
    el.tokenModalSet.addEventListener('click',()=>{
      const token=el.tokenModalInput.value.trim();if(!token)return;
      state.token=token;el.tokenModalOverlay.style.display='none';
      if(!loadCache()){loadCatalog();}
      else renderCards();
    });

    // Load from GitHub
    async function loadCatalog(){
      try{const res=await fetch(fixedConfig.catalogUrl,{cache:'no-store'});const data=await res.json();
        state.channels=Array.isArray(data)?data:[data];renderCards();
      }catch(err){alert('Failed to load:'+err.message);}
    }

    // Init
    el.tokenModalOverlay.style.display='flex';
  </script>
</body>
</html>
